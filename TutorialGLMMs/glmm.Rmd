---
title: "LMMs and GLMMs: estimation and model selection"
author: "J.-B. Durand"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Examples for binary, count and categorical data analysis by GLMMs

```{r}
library(lme4) # Tested with version 1.1.10
```

```{r}
packageVersion("lme4") # Tested with version 1.1.26
```

## Binary data

### True model without individual (tree) effect
```{r}
set.seed(0)
n = 1000 # sample sizes
nm.f1 = 3
nm.r1 = round(sqrt(n)) # number of random effects
set.seed(0)
# Predictors
f1 = sample(seq(1,nm.f1), n, replace=TRUE) # qualitative: factor
f2 = round(rnorm(n, 50, 10),2) # quantitative
# Random effects, not used here yet to simulate response variable
# but we pretend data come from nm.r1 individuals
r1 = sample(seq(1,nm.r1), n, replace=TRUE)

# Design matrix
X.f = matrix(0, nrow=n, ncol=nm.f1+2)
# 1st column of ones: intercept
X.f[,1] = 1
for (i in 1:nm.f1) {X.f[,i+1] = as.numeric(f1==i)}
X.f[,nm.f1+2] = f2

# True regression parameters
# Parameter for first value of factor F1 set to 0 for
# the sake of identifiability
bp = c(50, 0, 5, -5, -1)

# Linear predictor
LP = X.f %*% bp

datg.all = cbind(f1, f2, r1)
datg.all = data.frame(datg.all)
names(datg.all) = c("F1", "F2", "R1")

datg.all$F1 = as.factor(datg.all$F1)
datg.all$R1 = as.factor(datg.all$R1)

set.seed(0)

Y.g = rbinom(n, 1, exp(LP)/(1+exp(LP)))

datg.all = cbind(Y.g, datg.all)
write.table(datg.all, "Y_binary_no_random_effect.txt", quote=FALSE, row.names=FALSE)
```

# Print data. Data files should look like this
# The first column are zeros and ones, values of the variable to predict
```{r}
print(datg.all[1:10,])
```
# The lines above are to simulate data.
# A true analysis process would start from here

```{r}
datg.all = read.table("Y_binary_no_random_effect.txt", header=TRUE, as.is=TRUE)
datg.all$F1 = as.factor(datg.all$F1)
datg.all$R1 = as.factor(datg.all$R1)
```

# Model to be estimated (logistic regression, consistent with true model):
$$
\log \frac{P(Y_{h,i,j}=1)}{P(Y_{h,i,j}=0)} = a + b F_{1,h,i,j} + c_h
$$
where $h$ corresponds to a possible value of $F_2$, $i$ is an individual and $j$ a replicate measurement.

```{r}
# Parameter estimation (using true model)
modpf = glm(Y.g~ F1+F2, family="binomial", data=datg.all)
summary(modpf)
```
# Note that estimated parameters are close from true parameters (50, 5, -5, -1)

# Confidence interval
```{r}
fm1pP = confint(modpf, method="profile", level=0.95, oldNames = FALSE)
print(fm1pP)
```

# Estimate a model with random individual effect while there is none in data

# Model to be estimated (logistic regression, not consistent with true model since truly there is no $\varepsilon_i$, i.e., $\sigma^2=0$):
$$
\log \frac{P(Y_{h,i,j}=1)}{P(Y_{h,i,j}=0)} = a + b F_{1,h,i,j} + c_h + \varepsilon_i
$$
where $\varepsilon_i$ independent ${\mathcal N}(0,\sigma^2)$.

```{r}
fm1pP.ran = glmer(Y.g ~ F1+F2 + (1|R1), family="binomial", data=datg.all)

summary(fm1pP.ran)
```
# Note that some individual random effects are found 
# In the sense that variance of R1 seems far from 0
# However 0 is in the confidence intervals for variance (see below)

# Confidence interval
```{r}
fm1blgrP = confint(fm1pP.ran, method="profile", level=0.95, oldNames = FALSE)
print(fm1blgrP)
```

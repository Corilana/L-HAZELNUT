Bootstrap: docker
From: ubuntu:16.04

# .def files for Singularity image to be used with em-analysis.

# Tested with singularity version 3.6.4

# Warning: using a VPN at build time could prevent R from installing

%help
This singularity image contains python libraries to run eye-movement analysis data.
You may run the image by using
singularity run --app jupyter -e -B /my_AppleCultivarsTreatments:/scratch:rw VPlants.simg
where /my_scratch is the name of a host directory containing some jupyter notebook(s) you want to run withing the container and assuming VPlants.simg is the name of the file produce by singularity build on the present definition file.
If you just want to run an ipython console, use
singularity run --app -e console VPlants.simg

%labels
AUTHOR Jean-Baptiste Durand
VERSION="1.2"
VCS-URL="git@github.com:jbdurand/AppleCultivarsTreatments.git"
VCS-REF="ba844a5c9ce39eb495b6ffdb909ff3eaef8e17c1"
BUILD.CMD="sudo singularity build VPlants.simg VPlants.def"

%setup
mkdir -p /mnt/devlp/

# git clone git@github.com:jbdurand/AppleCultivarsTreatments.git

# files to copy inside the image
%files
./Code/VPlants/    /mnt/devlp/

%environment
export LANG=C.UTF-8 LC_ALL=C.UTF-8
# R version used here

%post

# Change mirror for ubuntu packages
# sed -i 's|http://archive.ubuntu.com/|http://fr.archive.ubuntu.com/|g' ${SINGULARITY_ROOTFS}/etc/apt/sources.list

apt update && apt install -y gedit && \
    apt install -y git

# Install packages for openalea / vplants compilation
apt install -y freeglut3-dev
apt install -y libboost-python1.58.0 libboost1.58-dev libboost-python1.58-dev
apt install -y libqt4-dev libqt4-dev-bin
apt install -y libreadline6 libreadline6-dev
apt install -y pkg-config
apt install -y pyqt4-dev-tools
apt install -y python-matplotlib
apt install -y python-qt4 python-qt4-dev
apt install -y python-setuptools 
apt install -y scons 

apt install -y python-pip 
# Install packages required at execution

# Solve issue ImportError: cannot import name 'main'
# in pip 

hash pip

# pip install --upgrade pip==19.3.1

python2 -m pip install --upgrade pip==19.3.1 

python2 -m pip install numpy==1.13.3
python2 -m pip install pandas==0.23.4
python2 -m pip install matplotlib==2.0.2
python2 -m pip install six==1.11.0

# Install zmq through pip for version control
apt remove -y python-zmq
    
python2 -m pip install pyzmq==18.1.0

python2 -m pip install jupyter==1.0.0 
python2 -m pip install notebook==5.7.8
python2 -m pip install jupyter_core==4.6.3
python2 -m pip install ipykernel==4.10.1
python2 -m ipykernel install --user
python2 -m pip install pytest==4.6.9
python2 -m pip install graphviz==0.14
python2 -m pip install seaborn==0.9.1
python2 -m pip install unidecode
python2 -m pip install xlrd==1.2.0
python2 -m pip install pathlib
python2 -m pip install dill==0.3.1.1

apt install -y graphviz

# Compile openalea / vplants packages
cd /mnt/devlp/VPlants/lib/openalea
python multisetup.py install
alea_config
cd ../vplants/tool
python setup.py install
alea_config
cd ../stat_tool
python setup.py install
alea_config
cd ../sequence_analysis
python setup.py install
alea_config

# Gnuplot installation
apt install -y gnuplot 
apt install -y gnuplot-x11
apt install -y gnuplot-tex 
apt install -y python-gnuplot

    
# Install gnuplot-py
cd /mnt/devlp/VPlants/lib/gnuplot-py-1.8/
python2 setup.py install
alea_config

# Install seqint    
cd /mnt/devlp/VPlants/
python2 setup.py install

# Install visu-scanpath
python2 -m pip install Pillow==4.3.0

export R_VERSION="3.6.3-1xenial"
# R repository mirror to install extra packages
# export R_REPOS="https://stat.ethz.ch"
export R_REPOS="https://pbil.univ-lyon1.fr"

# Install R dependencies
apt install -y software-properties-common apt-transport-https
apt update

add-apt-repository -y "deb $R_REPOS/CRAN/bin/linux/ubuntu xenial-cran35/"
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 51716619E084DAB9
apt update
apt install -y r-base=$R_VERSION
apt install -y libcurl4-openssl-dev libssl-dev libxml2-dev
apt install -y build-essential
apt install -y libtool libtool-bin
apt install -y libfontconfig1-dev
add-apt-repository -y "ppa:cran/libgit2"
add-apt-repository -y ppa:ubuntugis/ppa && apt-get update
add-apt-repository -y ppa:nextgis/ppa && apt-get update 
apt install -y libssh2-1-dev libgit2-dev
apt install -y libharfbuzz-dev libfribidi-dev
apt install -y libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev 
apt install -y cmake
apt remove -y gdal-bin
apt remove -y --auto-remove gdal-bin
apt purge -y gdal-bin
apt purge -y --auto-remove gdal-bin 
apt update
apt install -y gdal-bin proj-bin libgdal-dev=2.4.0+10-0xenial1 libproj-dev=4.9.2-2
apt install -y libudunits2-dev=2.2.20-1 libgeos-dev=3.7.0+4-0xenial1
apt install -y libgdal1-dev 
apt install -y libpq-dev

mkdir /root/r_analysis
cd /root/r_analysis
export R_CONTRIBS="https://cloud.r-project.org"
export TAR="/bin/tar"
export GDAL_DATA="/usr/share/gdal/"

# Use packageVersion to find version of installed package

echo 'install.packages("devtools", repos="'$R_CONTRIBS'")' >> r_install.txt
echo 'library("devtools")' >> r_install.txt
echo 'install_version("nloptr", version="2.0.3", repos="'$R_CONTRIBS'")' >> r_install.txt
echo 'install_version("lme4", version="1.1.31", repos="'$R_CONTRIBS'")' >> r_install.txt
echo 'install_version("nlme", version="3.1.158", repos="'$R_CONTRIBS'")' >> r_install.txt
echo 'install_version("MCMCglmm", version="2.34", repos="'$R_CONTRIBS'")' >> r_install.txt
echo 'install_version("permute", version="0.9.7", repos="'$R_CONTRIBS'")' >> r_install.txt
echo 'install_version("doParallel", version="1.0.17", repos="'$R_CONTRIBS'")' >> r_install.txt
echo 'install_version("rgeos", version="0.5.9", repos="'$R_CONTRIBS'")' >> r_install.txt
echo 'install_version("rgdal", version="1.6.2", repos="'$R_CONTRIBS'")' >> r_install.txt
echo 'devtools::install_github("IRkernel/IRkernel", ref="1.2", upgrade="always")' >> r_install.txt
# R kernel for jupyter
# Alternative to install.packages("devtools") + devtools::install_github("IRkernel/IRkernel"):
echo 'IRkernel::installspec(prefix = "/usr/local", user = FALSE)' >> r_install.txt

Rscript r_install.txt


echo 'library("devtools")' > r_install.txt
echo 'Sys.setenv(GDAL_DATA = "/usr/share/gdal/2.4/")' >> r_install.txt
echo 'install_version("sf", version="1.0.9", repos="'$R_CONTRIBS'")' >> r_install.txt
echo 'remotes::install_version("INLA", version="18.07.12",repos=c(getOption("repos"),INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)' >> r_install.txt

Rscript r_install.txt

echo 'library("devtools")' > r_install.txt
echo 'Sys.setenv(GDAL_DATA = "/usr/share/gdal/2.4/")' >> r_install.txt
echo 'install_version("inlabru", version="2.6.0", repos="'$R_CONTRIBS'")' >> r_install.txt

Rscript r_install.txt


# Presumably the last rpy2 version working with python2.7
python2 -m pip install rpy2==2.8.6

rm -Rf /root/r_analysis

# Clear apt cache
rm -rf /var/lib/apt/lists/*

# Set environment variables
echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib/python2.7/dist-packages/VPlants.Sequence_analysis-1.2.0-py2.7-linux-x86_64.egg/lib/:/usr/local/lib/python2.7/dist-packages/VPlants.Tool-1.2.0-py2.7-linux-x86_64.egg/lib/:/usr/local/lib/python2.7/dist-packages/VPlants.Stat_Tool-1.2.0-py2.7-linux-x86_64.egg/lib/' >>$SINGULARITY_ENVIRONMENT

%runscript
# /opt/run_jupyter.sh --notebook-dir=$HOME/notebooks --ip="*" --port 8888

##############################
# App section
##############################

##############################
# Console App 
##############################

%apprun console
ipython

%apphelp console
Use "run --app console -e VPlants.simg" to run an ipython console

##############################
# Jupyter App 
##############################

%apprun jupyter
jupyter notebook --ip 0.0.0.0 --no-browser --allow-root --notebook-dir="/scratch"

%apphelp jupyter
Use "run --app jupyter -e VPlants.simg" to run a jupyter notebook

